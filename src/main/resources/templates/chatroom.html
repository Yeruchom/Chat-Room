<!DOCTYPE html>
<!--<html lang="en">-->
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>ChatRoom</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">

    <!--this does not work and i don't know wy, so I put the js inside the html-->
    <!--    <script type="text/javascript" src="../fetchmessages.js"></script>-->

<script>
 document.addEventListener('DOMContentLoaded', function () {
        // console.log("in html");
        FetchMessages();
        FetchConnected();
        setInterval(FetchMessages, 10*1000);
        setInterval(FetchConnected, 10*1000);
    }, false);

    function FetchMessages() {
        let lastId = document.getElementById("data").innerHTML;
            lastId = (lastId != undefined && lastId > 0) ? lastId : 0;

        let url = new URL("/chatroom/getChat/"+ lastId, window.location.href);
        fetch(url).then(
                function (response) {
                     // handle the error
                    if (response.status !== 200) {
                        console.log("there was an error. response.status: ", response.status);
                        return;
                    }
                    response.text().then((text)=> {
                        if (text.length > 0)
                            DisplayChat(JSON.parse(text));
                        else {
                            let chat = document.getElementById("chat");
                            if(chat.childElementCount == 0) {
                                let noUser = document.createElement("li");
                                noUser.className = "list-group-item list-group-item-info";
                                noUser.innerHTML = "there are no messages yet";
                                chat.appendChild(noUser);
                            }
                        };
                    })
                })
                .catch(function (err) {
                    console.log('There was an error fetching ' + url +'. error: '+  err);})
    }

    function DisplayChat(chatMessages){

        let chatWindow = document.getElementById("chat");

        // first clear all messages
        while (chatWindow.hasChildNodes())
            chatWindow.removeChild(chatWindow.lastChild);

        // display the messages
        for(var i in chatMessages){
            let m = document.createElement("li");
            m.className = "list-group-item list-group-item-info";
            m.innerHTML = "name: " + chatMessages[i].name + " " + chatMessages[i].text;
            chatWindow.appendChild(m);
        }
        if(i !== undefined)
        {
            document.getElementById("data").innerHTML = chatMessages[i].id;
            // console.log("i:", i, " id ", document.getElementById("data").innerHTML);
        }
    }

    function FetchConnected() {

        let numberOfConnected = document.getElementById("numberOfConnected").innerHTML;
        numberOfConnected = (numberOfConnected != undefined && numberOfConnected > 0) ? numberOfConnected : 0;
        let url = new URL("/connectedUsers/" + numberOfConnected, window.location.href);

        fetch(url).then(
            function (response) {
                 // handle the error
                if (response.status !== 200) {
                    console.log("there was an error. response.status: ", response.status);
                    return;
                }
                response.text().then((text)=> {
                    if (text.length > 0)
                        DisplayConnected(JSON.parse(text));
                    else
                    {
                        let con = document.getElementById("connected");
                        if(con.childElementCount == 0){
                            let noUser = document.createElement("li");
                            noUser.className = "list-group-item list-group-item-info";
                            noUser.innerHTML = "No other user is connected";
                            con.appendChild(noUser);
                        }

                        return;
                    }
                })
                // response.json().then(DisplayConnected);
            })
            .catch(function (err) {
                console.log('There was an error fetching ' + url +'. error: '+  err);})
    }

    function DisplayConnected(users){

        let connectedWindow = document.getElementById("connected");
        // first clear all messages
        while (connectedWindow.hasChildNodes())
            connectedWindow.removeChild(connectedWindow.lastChild);

        // display the messages
        for(i in users){
            let m = document.createElement("li");
            m.className = "list-group-item list-group-item-info";
            m.innerHTML = i.toString() + " - " + users[i] + " is connected ";
            connectedWindow.appendChild(m);
        }
        if(i !== undefined)
        {
            document.getElementById("numberOfConnected").innerHTML = i;
            // console.log("i:", i, " id ", document.getElementById("data").innerHTML);
        }
    }

</script>

</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1>welcome to our chatroom</h1>
        </div>
        <div class="col">
            <a class="btn btn-primary" href="/chatroom/search" role="button">Search</a>
        </div>
    </div>
    <div class="row">
        <div class="col-12 col-md-4">Conected users:
            <ul class="list-group" id="connected">
            </ul>
        </div>
        <div class="col-12 col-md-8">Chat messages:
            <ul class="list-group" id="chat">
            </ul>
        </div>
    </div>

<!--    this is for js to have information about the chat-->
    <div style="display: none" id="data"></div>
    <div style="display: none" id="numberOfConnected"></div>

    <div class="row">
        <div class="col-12">
            <form action="#" th:action="@{/chatroom/sendMessage}" th:object="${message}" method="post">
                <div class="row">
                    <div class="form-group col-md-6">
                        <label for="text" class="col-form-label" >Your message</label>
                        <input type="text" th:field="*{text}" class="form-control" id="text" name="text" placeholder="Message">

                        <span th:if="${#fields.hasErrors('text')}" th:errors="*{text}" class="text-danger"></span>
                    </div>
                    <input type="hidden" name="name" th:value="${name}">

                </div>
                <div class="row">
                    <div class="col-md-6 mt-5">
                        <input type="submit" class="btn btn-primary" value="send message">
                    </div>
                </div>
            </form>
        </div>
    </div>

    <a href="/logout">Logout</a>
</div>

</body>




</html>